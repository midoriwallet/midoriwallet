<!DOCTYPE html>
<html lang="en" class="platform--<%= env.VITE_PLATFORM %>">
  <head>
    <script>
      // Apply theme IMMEDIATELY to prevent flash
      (function() {
        try {
          const theme = localStorage.getItem('_cs_theme') || 'auto';
          const html = document.documentElement;
          html.classList.add('theme--' + theme);
          
          // Determine if dark mode should be active
          let isDark = false;
          if (theme === 'dark') {
            isDark = true;
          } else if (theme === 'auto') {
            isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          }
          
          // Apply styles immediately
          if (isDark) {
            html.style.setProperty('--color-background', '#121614');
            html.style.setProperty('--color-text', '#e8e8e8');
          }
        } catch (e) {
          document.documentElement.classList.add('theme--auto');
        }
        
        // Force body background immediately when body is available
        const applyBodyStyles = function() {
          const theme = localStorage.getItem('_cs_theme') || 'auto';
          let isDark = false;
          if (theme === 'dark') {
            isDark = true;
          } else if (theme === 'auto') {
            isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          }
          
          if (isDark) {
            const bgColor = window.innerWidth >= 1024 ? '#1e2421' : '#121614';
            document.body.style.setProperty('background-color', bgColor, 'important');
            document.body.style.setProperty('color', '#e8e8e8', 'important');
          }
        };
        
        if (document.body) {
          applyBodyStyles();
        } else {
          document.addEventListener('DOMContentLoaded', applyBodyStyles);
        }
        
        // Reapply on window resize
        try {
          window.addEventListener('resize', applyBodyStyles);
        } catch (e) {
          // ignore
        }
      })();
      
      // Second attempt - use MutationObserver to force styles
      (function() {
        if (!document.body) return;
        const observer = new MutationObserver(function() {
          const theme = localStorage.getItem('_cs_theme') || 'auto';
          let isDark = false;
          if (theme === 'dark') {
            isDark = true;
          } else if (theme === 'auto') {
            isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          }
          
          if (isDark) {
            const current = document.body.style.backgroundColor;
            const expected = window.innerWidth >= 1024 ? 'rgb(30, 36, 33)' : 'rgb(18, 22, 20)';
            if (current !== expected && !current.includes('18, 22, 20') && !current.includes('30, 36, 33')) {
              const bgColor = window.innerWidth >= 1024 ? '#1e2421' : '#121614';
              document.body.style.setProperty('background-color', bgColor, 'important');
              document.body.style.setProperty('color', '#e8e8e8', 'important');
            }
          }
        });
        
        if (document.body) {
          observer.observe(document.body, { attributes: true, attributeFilter: ['style', 'class'] });
        } else {
          document.addEventListener('DOMContentLoaded', function() {
            observer.observe(document.body, { attributes: true, attributeFilter: ['style', 'class'] });
          });
        }
      })();
    </script>
    <title>Midori Wallet</title>
    <meta charset="UTF-8" />
    <% if (env.VITE_PLATFORM === 'android') { %>
      <meta name="color-scheme" content="light dark"/>
    <% } %>
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self';
      script-src 'self' 'unsafe-eval' 'unsafe-inline' data:;
      style-src 'self' 'unsafe-inline';
      connect-src
        'self'
        <% if (NODE_ENV === 'development') { %>http://localhost:*/<% } %>
        <%= env.VITE_SITE_URL %>
        <%= env.VITE_API_CSP %>
        <% if (['phonegap', 'electron'].includes(env.VITE_BUILD_TYPE)) { %>
        <%= env.VITE_SITE_URL_TOR %>
        <%= env.VITE_API_CSP_TOR %>
        <% } %>
        wss://*.walletconnect.org/
        wss://*.walletconnect.com/
        https://*.walletconnect.org/
        https://*.walletconnect.com/
        https://*.sentry.io;
      frame-src
        'self'
        https://*.walletconnect.org/
        https://*.walletconnect.com/;
      img-src
        'self'
        <% if (NODE_ENV === 'development') { %>http://localhost:*/<% } %>
        <%= env.VITE_SITE_URL %>
        <%= env.VITE_API_CSP %>
        <% if (['phonegap', 'electron'].includes(env.VITE_BUILD_TYPE)) { %>
        <%= env.VITE_SITE_URL_TOR %>
        <%= env.VITE_API_CSP_TOR %>
        <% } %>
        https://www.gravatar.com/
        data:;
    "/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0, viewport-fit=cover">
    <meta name="description" content="Midori Wallet works with any ERC20 / BEP20 / ARC20 / TRC20 tokens and supports the most popular cryptocurrencies.">
    <meta name="format-detection" content="telephone=no"/>
    <meta name="format-detection" content="address=no"/>
    <meta name="apple-itunes-app" content="app-id=980719434"/>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#000">
    <meta name="msapplication-TileColor" content="#2C3832">
    <meta name="theme-color" content="#2C3832">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Midori Wallet">
    <style>
      @import '/src/assets/styles/common.scss';
      
      /* Theme CSS Variables - Force inclusion */
      :root {
        --color-text: #222;
        --color-secondary: #616763;
        --color-secondary-light: #f6f8fa;
        --color-primary: #05a76b;
        --color-primary-brand: #05a76b;
        --color-primary-light: #f0f9f2;
        --color-danger: #dd230e;
        --color-danger-light: #fcf5ef;
        --color-divider: #f0f0f0;
        --color-background: #fff;
        --color-background-dark: #2c3832;
        --color-white: #fff;
        --color-black: #000;
        --color-gray: #d3d3d3;
      }
      
      html.theme--dark {
        --color-text: #e8e8e8;
        --color-secondary: #a8aaa9;
        --color-secondary-light: #1e2421;
        --color-primary: #06c97f;
        --color-primary-brand: #06c97f;
        --color-primary-light: #0d2e22;
        --color-danger: #ff4d36;
        --color-danger-light: #2d1915;
        --color-divider: #2d3330;
        --color-background: #121614;
        --color-background-dark: #1a1e1c;
        --color-white: #1a1e1c;
        --color-black: #e8e8e8;
        --color-gray: #4a4a4a;
      }
      
      /* Force dark background with high specificity */
      html.theme--dark body,
      html.theme--dark body.theme--dark {
        background-color: #121614 !important;
        color: #e8e8e8 !important;
      }
      
      @media (min-width: 1024px) {
        html.theme--dark body,
        html.theme--dark body.theme--dark {
          background-color: #1e2421 !important;
        }
      }
      
      @media (prefers-color-scheme: dark) {
        html.theme--auto {
          --color-text: #e8e8e8;
          --color-secondary: #a8aaa9;
          --color-secondary-light: #1e2421;
          --color-primary: #06c97f;
          --color-primary-brand: #06c97f;
          --color-primary-light: #0d2e22;
          --color-danger: #ff4d36;
          --color-danger-light: #2d1915;
          --color-divider: #2d3330;
          --color-background: #121614;
          --color-background-dark: #1a1e1c;
          --color-white: #1a1e1c;
          --color-black: #e8e8e8;
          --color-gray: #4a4a4a;
        }
        
        html.theme--auto body,
        html.theme--auto body.theme--auto {
          background-color: #121614 !important;
          color: #e8e8e8 !important;
        }
      }
      
      @media (prefers-color-scheme: dark) and (min-width: 1024px) {
        html.theme--auto body,
        html.theme--auto body.theme--auto {
          background-color: #1e2421 !important;
        }
      }
    </style>
  </head>
  <body>
    <style id="theme-override">
      /* Force dark theme background - CRITICAL FIX */
      html.theme--dark body {
        background-color: #121614 !important;
        color: #e8e8e8 !important;
      }
      
      @media (min-width: 1024px) {
        html.theme--dark body {
          background-color: #1e2421 !important;
        }
      }
      
      @media (prefers-color-scheme: dark) {
        html.theme--auto body {
          background-color: #121614 !important;
          color: #e8e8e8 !important;
        }
      }
      
      @media (prefers-color-scheme: dark) and (min-width: 1024px) {
        html.theme--auto body {
          background-color: #1e2421 !important;
        }
      }
    </style>
    <noscript>
      <div class="noscript">
        <div class="noscript__title">JavaScript is needed</div>
        <div class="noscript__message">Please enable it in your browser settings and refresh the page.</div>
      </div>
    </noscript>
    <div id="app"></div>
    <div id="error" class="error" style="display: none;">
      <div class="error__container">
        <div class="error__frame">
          <div class="error__logo-wrapper">
            <img class="error__logo" src="/src/assets/svg/logo.svg" loading="lazy">
          </div>
          <div class="error__error">
            <div class="error__title">Error</div>
            <div class="error__message">Update your browser or install Chrome on your device.</div>
          </div>
        </div>
        <div class="error__copyright"> Â© <%= new Date().getFullYear() %> Astian </div>
      </div>
    </div>
    <script type="module" src="/src/main.js"></script>
    <script>
      try {
        if (!Promise) throw new Error('Promise not supported');
        if (!BigInt) throw new Error('BigInt not supported');
        if (!Proxy) throw new Error('Proxy not supported');
        if (!localStorage) throw new Error('localStorage not supported');
        if (document.createElement('script').noModule === undefined) throw new Error('ES modules not supported');
      } catch (err) {
        console.error(err);
        document.getElementById('app').remove();
        document.getElementById('error').style.display = 'block';
      }
    </script>
    <% if (env.VITE_BUILD_TYPE === 'phonegap') { %>
      <script src="cordova.js"></script>
    <% } %>
  </body>
</html>
